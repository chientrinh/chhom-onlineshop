<?php
/**
 * $URL: https://tarax.toyouke.com/svn/MALL/backend/modules/casher/views/default/_flower.php $
 * $Id: _flower.php 1503 2015-09-18 07:41:11Z mori $
 *
 * $searchModel  Model
 * $dataProvider ActiveDataProvider of \backend\models\Product
 */
use \yii\helpers\Html;
use \yii\helpers\ArrayHelper;

$matrix = \common\models\Subcategory::find()->andWhere(['parent_id' => 9 /* フラワーエッセンス */ ])->column();
$queries = [];
foreach($matrix as $sub_id)
    $queries[$sub_id] = \common\models\ProductSubcategory::find()
               ->with('product','product.stock')
               ->joinWith([
                   'product.remedy' => function (\yii\db\ActiveQuery $query) {
                       $query->orderBy('abbr');
                   }])
               ->andWhere(['subcategory_id' => $sub_id]);
?>

<?= $this->render('__tabs',[
    'company' => $searchModel->company->company_id,
]) ?>

<?php foreach($queries as $sub_id => $query): ?>

    <?php $subcategory = \common\models\Subcategory::findOne($sub_id); ?>
    <div class="col-md-3">
        <div class="panel panel-info">
            <div class="panel-heading">
                <?= $subcategory->name ?>
            </div>
            <div class="panel-body">
                <?= \yii\widgets\ListView::widget([
                    'dataProvider' => new \yii\data\ActiveDataProvider([
                        'query' => $query,
                        'pagination' => false,
                    ]),
                    'layout'   => '{items}',
                    'itemView' => function ($model, $key, $index, $widget) {
                        $r = $model->product->remedy;
                        $s = $model->product->stock;
                        $title = sprintf('%s:%s ￥%s',$r->abbr,$r->ja, number_format($s->price));
                        return Html::a($r->abbr,['apply','target'=>'remedy','rid'=>$s->remedy_id,'pid'=>$s->potency_id,'vid'=>$s->vial_id],['class'=>'stock','title'=>$title]);
                    },
                ]) ?>
           </div>
        </div>
    </div>
<?php endforeach ?>

